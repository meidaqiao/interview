<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>mvvm</title>
</head>
<body>
    <div id="app">
        <input type="text" v-model="name">
        <h1 id="name">{{name}}</h1>
    </div>
</body>
</html>
<script>
    /*监听数据,方法就是数据劫持*/
    function defineReactive(data, key, val) {
        var dep = new Dep()
        Object.defineProperty(data,key,{
            enumerable:true,//对象属性是否可通过for-in循环，flase为不可循环，默认值为true
            configurable:true,//能否使用delete、能否需改属性特性、或能否修改访问器属性、，false为不可重新定义，默认值为true
            writable:false,//对象属性是否可修改,flase为不可修改，默认值为true
            get(v: any): void {
                if (Dep.target) {  // 判断是否需要添加订阅者
                    dep.addSub(Dep.target); // 在这里添加一个订阅者
                }
                return val
            },
            set(newVal: any): void {
                if (val === newVal) {// 判断值是否发生改变
                    return;
                }else {
                    val = newVal;
                    dep.notify(); // 通知订阅者, 触发订阅者的更新操作
                }
            }
        })
    }
    function Dep() {
        this.subs = []
    }
    Dep.prototype = {
        addSub : function (sub) {
            this.subs.push(sub)
        },
        notify : function () {
            this.subs.forEach(function (sub) {
                sub.update()
            })
        }
    }
    /*订阅者*/
    function Watcher(vm,exp,cb) {
        this.vm = vm;
        this.exp = exp;
        this.cb = cb;
        this.value = this.get()
    }
    Watcher.prototype = {
        get: function () {
            Dep.target = this;
            var value = this.vm.data[this.exp];
            Dep.target = null;
            return value
        },
        update: function () {
            this.run()
        },
        run: function () {
            var value = this.vm.data[this.exp];
            var oldVal = this.value;
            if (value !== oldVal) {
                this.value = value;
                this.cb.call(this.vm, value, oldVal);
            }
        }
    }
    function SelfVue (data, el, exp) {
        this.data = data;
        observe(data);
        el.innerHTML = this.data[exp];  // 初始化模板数据的值
        new Watcher(this, exp, function (value) {
            el.innerHTML = value;
        });
        return this;
    }
    var ele = document.querySelector('#name');
    var selfVue = new SelfVue({
        name: 'hello world'
    }, ele, 'name');

    window.setTimeout(function () {
        console.log('name值改变了');
        selfVue.data.name = 'canfoo';
    }, 2000);
</script>